![nanostructure](https://www.polymtl.ca/nanostructures/images/ldip_cc-sib-model_1-large.stmvpjet-2-766.jpg)

 ####################################################################################### 
 ```
  _   _                       _                   _                    _          _      
 | \ | | __ _ _ __   ___  ___| |_ _ __ _   _  ___| |_ _   _ _ __ ___  | |    __ _| |__   
 |  \| |/ _` | '_ \ / _ \/ __| __| '__| | | |/ __| __| | | | '__/ _ \ | |   / _` | '_ \  
 | |\  | (_| | | | | (_) \__ \ |_| |  | |_| | (__| |_| |_| | | |  __/ | |__| (_| | |_) | 
 |_| \_|\__,_|_| |_|\___/|___/\__|_|   \__,_|\___|\__|\__,_|_|  \___| |_____\__,_|_.__/  
 
 ```                                                                                        
 ####################################################################################### 


# Table of Contents

- [Description](#description)
- [Prerequisites](#prerequisites)
- [Getting Started](#getting-started)
- [Usage](#usage)
    - [Bash Scripts](#bash-scripts)
        - [baderanalysis](#baderanalysis)
        - [scanSTM](#scanstm)
        - [xv2fdf](#xv2fdf)
        - [PDOS-Gen](#PDOS-Gen)
        - [pldos](#pldos)
        - [plot_muliken](#plot_muliken)
        - [write_denchar](#write_denchar)
        - [simAFM](#simafm)
    - [Python Scripts](#python-scripts)
        - [bader2pdb](#bader2pdb)
        - [bader2spind](#bader2spind)
        - [plot_Badercharge](#plot_baderchargepy)
        - [plot_STM-lib](#plot_stm-lib)
- [Contributing](#contributing)

# Description

Multiple scripts to optimize and facilitate data analysis and processing of files generated by SIESTA (4.1.5)

Note : The scripts are designed with SIESTA data files but can be adapted to other software too

# Prerequisites

These are the software version used originally in making the scripts. Any other version might also work 

- Python (version 3.10.2)
    * Matplotlib (version 3.7.2)
    * Numpy (version 1.25.2)
    * Basic python libraries (sys, os, argparse, ...)
- Bash (version 5.1.16) 



Note : Other shells might work too but scripts will have to be adapted

# Getting Started

1. Clone or download the project repository.
2. Unzip the downloaded file.(should already be done)
3. Move the bash scripts to an appropriate directory in PATH to be accessible from the commandline (optionnal)
4. Move the python scripts to the desired directory (optionnal)
5. See instructions below for usage of specific scripts

# Usage


### Running Python Scripts
You can run the python scripts directly in the command line with its associated path. For example, to run a python script that takes the System's Label as argument, you can run this command in terminal.   

```bash
python path_to_my_python_script/pyton_script.py YourLabel 
```

However, I suggests to create a seperate bash script (in a directory added to your PATH) that run your python scripts. This way you can run the command from any directories which makes the analysis easier and more importantly FASTER! Here is an example of a simple bash script that runs the same python script from the previous example. 

```bash
#!/bin/bash
LABEL=$1
python path_to_my_python_script/pyton_script.py $LABEL
```
Don't forget to give the permissions to your bash script by runing this command in the terminal

```bash
chmod u+x YourBashScript
```
Some python scripts may have more than one argument and/or options. If you want to use the shell scripting approach, you will need to adapt your bash scripts to match the python's script arguments and/or options. All the python scripts presented in future sections will be showing the first method as indication, but I think shell scripting is a better approach
## Bash scripts

### baderanalysis
---

baderanalysis is a bash script that automatically performs the bader analysis with siesta files and returns the data in multiple output files. It is meant to speed up the process of bader analysis. 

Requirements : 
- bader executable downloadable here : [http://theory.cm.utexas.edu/henkelman/code/bader/](http://theory.cm.utexas.edu/henkelman/code/bader/)
- python scripts [bader2pdb](#bader2pdb) and [plot_Badercharge](#plot_badercharge) (optional)
- SIESTA SystemLabel.RHO file
- SIESTA SystemLabel.BADER file
- SIESTA SystemLabel.XV file
- SIESTA SystemLabel.STRUCT_OUT file (optionnal : only needed if grid non-orthogonal)
- SIESTA SystemLabel.xyz file (optionnal : only needed if python scripts are enabled)

IMPORTANT : You NEED to change the path to the python scripts in the baderanalysis script directly. The bader executable need to be in your PATH (accesssible via terminal)

To disable the python scripts, simply remove or comment lines calling the scripts (By default only the [bader2pdb](#bader2pdb) script is enabled). The script also offers multiple options depending if your grid is orthogonal, or if your calculation is spin polarized. 

Options :   
Usage: baderanalysis [-s] [-n] [-l label] [-h] 
+  -s                 Process spin-polarized data
+  -n                 Process with non-orthogonal grid
+  -l                 Specify label of your system (MANDATORY)
+  -h                 Display this help message

This script will output 5 files:
- SystemLabel-ACF.dat, SystemLabel-AVF.dat and SystemLabel-BCF.dat which are files created by the bader analysis itself, 
- SystemLabel-CT.pdb, which is a file created by the [bader2pdb](#bader2pdb) python script (refer to section its for more information)
- SystemLabel-CT.png, which is a file created by the [plot_Badercharge](#plot_badercharge) python script (refer to section its for more information)

By default, the script will delete all the .cube files generated by the bader analysis but you can prevent this by simply commenting the lines in the script that remove those files 


### scanSTM
---

The scanSTM bash script is meant to give multiple STM usage by scanning at multiple different height. It takes data from the SystemsLabel.LDOS file generated by SIESTA and generates multiple STM .dat files with the plstm util integrated with SIESTA. With the [plot_STM-lib](#plot_stm-lib) and the .dat files, it then generates an STM image for each height. 

Requirements : 
- SIESTA .LDOS file
- [plot_STM-lib](#plot_stm-lib) script provided in this project

The script requires multiple options in order to work properly. Here is the list of options available

Options:
+ -m MIN_HEIGHT   Minimal height in Angstrom (default: 2)
+ -M MAX_HEIGHT   Maximal height in Angstrom (default: 7)
+ -n NUM_STEPS    Number of steps between minimal and maximal heights (default: 10)
+ -l LABEL        System's label associated with .LDOS file (MUST PROVIDE)
+ -h              Display help message

The script generates multiple files. The STM data are stored in files named SystemLabel-SZ-$HEIGHT.dat and images are in files named SystemLabel-SZ-$HEIGHT.png where $HEIGHT is the constant height in Ang at which the image has been generated. 

IMPORTANT : You NEED to modify the path to the [plot_STM-lib](#plot_stm-lib) directly in the bash script

### xv2fdf
This script is a bash script called xv2fdf that uses the sisl python library to convert the SIESTA SystemLabel.XV geometry output file into a file called SystemLabel_new.fdf that contains the lattice vectors, atoms position and Grimme potential written in .fdf format. This script is really useful to extract the optimized geometry of a system that was obtained from a SIESTA relaxation calculation and to use it in a new calculation. To use it, you need the sisl library that can be downloaded using conda with this set of commands:
```bash
conda create -n sisl
conda activate sisl
conda config -- add channels conda-forge
conda install -c conda-forge python=3.9 scipy matlplotlib plotly netcdf4 sisl
```
You also need the SIESTA utilities fdf2grimme. In your directory, make sure to have SystemLabel.XV. To use the
script, in your directory, just type:
```bash
xv2fdf SystemLabel
```
This should create the file SystemLabel_new.fdf in the same directory.

### PDOS-Gen
This bash script uses the SIESTA utilities fmpdos and gnubands to extract the PDOS of each species into the ASCIIfile PDOS-SpecieLabel.dat and to extract the band structure into the ASCII file SystemLabel-BANDS.dat. You can then plot them with the method of your choicd. To use this script, you need the SIESTA utilities fmpdos and gnubands. You also need in your directory the files SystemLabel.PDOS, SystemLabel.bands and SystemLabel.fdf. The later is used to extract the SpeciesLabels and to loop over them with fmpdos. You also need the python script get_labels.py to do so. Write its path in the begenning of the PDOS-Gen script where specified. To use PDOS-Gen, just go in your directory and type the command:
```bash
PDOS-Gen
```
You can then follow the on-screen instructions.

### pldos
This bash script can be used to plot the band structures and the PDOS of systems. They work well for nanoribbons and could be adapted easily to systems in higher dimensions. To make these plots, pldos will use the following python scripts:
+ pldos.py (Plots a spin unpolarized PDOS)
+ plbands.py (Plot a spin unpolarized Band structure)
+ pldos_double.py (Plot a spin polarized PDOS)
+ plbands_double.py (Plot a spin polarized Band structure)
+ Mag.py (Reads the magnetic configuration (AFM, FM, DIA) from the system label)
+ read_Fermi.py (Reads the Fermi level from the SystemLabel.out file)

You can, of course, use these codes individually and adapt them to your own use. You need to write the path to these scripts at the beginning of the pldos bash script. To use this script, you need the python library numpy and matplotlib. In the directory, you need the files SystemLabels.out and SystemLabel.DOS. You also need the files PDOS-SpeciesLabel.dat and SystemLabel-BANDS.dat that can be generated with PDOS-Gen (see 10.2). When using pldos, if you have the string "-FM-" in your SystemLabel, pldos will plot spin-polarized PDOS and Band structures. Else, it will plot a single PDOS and Band-structure. To use pldos, just type: 
```bash
pldos
```
in your directory and follow the on-screen instructions. You can also add the options -g and -p. -g will use the bash script PDOS-Gen to generate the PDOS and band structure ASCII files to be plotted. -p will plot the DOS of the pristine system in dashed line into the plot located in ../BN/*.DOS. 

### plot_muliken
This bash script reads the mulliken atomic population, uses it calculate the local spin density and plot it on the 2D structure. This script uses the following python codes and bash script to work:

+ calc_pop (Bash. Extract the mulliken population of the SystemLabel.out file and write it in the files arquivoup
and arquivodown. This script is adapted from https://github.com/caiovincius/SIESTA-Shell-Tools.)
+ read_mulliken.py (Python. Reads the mulliken charges from arquivoup and arquivodown and compute the diference between mulliken charge associated to spin up and down. Write it as the fourth column of an .xyz file.)
+ plot_mulliken.py (Python. Plot the fourth column of an .xyz file onto the 2D structure with matplotlib)

You can of course use any of these codes individually. Make sure to write the path to the python codes at the beginning of plot_mulliken. In your directory, you will need the files SystemLabel.out and SystemLabel.xyz. To use the script, use the following command:

```bash
plot_muliken SystemLabel
```
This will generate the file SystemLabel-Mag.png 

Note: This script is very similar to the python script script presented below  : plot_Badercharge. The option -m in the python script will eventually merge the two scripts together.

### write_denchar
This bash script reads information found into SystemLabel.fdf and SystemLabel.XV to write an input file called denchar_input.fdf that can be given to the SIESTA utility denchar to plot charge density and wavefunctions of a system. The file generated respect the format that is given in the denchar documentation. To change the parameters of that input file and to know how to use denchar, please refer to that documentation. Note that the script works for orthogonal unit cells but could be adapted easily to non-orthogonal unit cells. The script uses the following python codes:
+ read_SpeciesLabel.py (read the SpeciesLabel block from the file SystemLabel.fdf)
+ read_unit_cell_denchar.py (Read the unit cell found in the file SystemLabel.XV)
Don't forget to write the path to these script at the beginning of write_denchar. To use it, just write this command in the directory:
```bash
write_denchar SystemLabel
```
You can also add the option -n [number] to change the number of grid points along each lattice vector. The vectors will be scaled by that number to get the number of points. By default, n=5. To use denchar, you only have to write this command:
```bash
denchar < denchar_input.fdf
```

### simAFM
This last script automates steps in order to plot FM-AFM simulated images using the ppafm code. I highly recommend taking a look at the documentation of that code. It can be found in the following git: https://github.com/ProbeParticle/ppafm. To use simAFM, you will need the following python code:
+ read_unit_cell.py (Read the unit cell from SystemLabel.XV)

Make sure to write the path to this code at the beginning of simAFM. First of all, you should download the ppafm code. With anaconda, just enter the following commands:
```bash
conda create=n ppafm python =3.11
conda activate ppafm
conda install pyqt o cl=icd=system =c conda=forge
pip install ppafm [opencl]
```
You should now be able to use the commands from ppafm. However, I added some modifications and fixes to the code. In order to simAFM to work, you will need to modify the python codes of ppafm. To do so, go to /home/your_username/anaconda3/envs/ppafm/lib/python3.11/site-packages. There should be a ppafm directory. Replace it with this directory: Vincent_Girouard_Stage_2023/Scripts/ppafm. Everything should now work fine. In the directory you want to use simAFM, you need the following files:
* SystemLabel.XV
* SystemLabel.xyz
* SystemLabel.VH or SystemLabel.xsf that contains the grid read in SystemLabel.VH by the SIESTA utility rho2xsf.

To use simAFM, just go in that directory and type the command:
```bash
simAFM [OPTIONS]
```
You can get further instructions and informations in the help menu by entering:
```bash
simAFM -h
```
If you don't have a params.ini file in your directory, simAFM will create one from a template I made and will ask you to edit it. params.ini contains all simulation parameters. Feel free to explore them. After editing the file, launch simAFM again and follow the on-screen instructions. Now let's take a look at the diferent command-line options that you can add.
- -help or -h

This option will open help menu
+ -xsf

This option will automatically generate SystemLabel.xsf from the SystemLabel.VH electrostatic potential file output by SIESTA using the SIESTA utility rho2xsf. However, to make this work, you will have to modify the code of rho2xsf. To do so, go to the rho2xsf source directory (some_path/siesta-4.1.5/Util/Contrib/APostnikov) and edit rho2xsf.f. Just uncomment lines 99 to 115, save the file and compile the program again by writing make in the
command line.

* -pos

This option plot on separated images the relaxed position of the probe particle.
+ -npy

This option instructs ppafm to save intermediate data into machine-readable files, which speeds up the calculations.

+ -cbar

This option will add a colorbar to the images.
+ -atoms

This option will plot the atom position in the image.
+ bonds

This option will plot the bonds between atoms in the image. However, I was not able to make it work well but this could be fixed easily.
+ fz

This option will plot the total vertical force experienced by the probe particle. Below, you can see examples of images that were generated with simAFM. The contrast of the images comes from the frequency shift if the cantilever

## Python scripts

### bader2pdb
---
The bader2pdb script is used to automatically take the data from the ACF.dat and .xyz files generated by SIESTA and BADER respectively, and create a .pdb file regrouping the data and calculate the charge transfer that can be used to visualize in VMD. The scripts is assuming that your ACF.dat files has been renamed to SystemLabel-ACF.dat (if spin polarized to SystemLabel-UP-ACF.dat and SystemLabel-DN-ACF.dat). If this is not the case please change to your filename in the script directly.

IMPORTANT : The atom numbers from the .xyz and the ACF.dat file must match in order to have the correct charge transfer associated with its atom. This should be the case, if you used the .XV file from siesta to generate the .cube files (from grid2cube or g2c utilities) used in the bader analysis

Requirements : 
- SIESTA .xyz file
- BADER ACF.dat file (you do not need the .BADER file)


If your calculation is spin polarized than you should add the '-s' or '--spin' flag before your label.

```bash
python path/to/script/bader2pdb.py -s YourSystemsLabel
```
You can also use the '-h' or '--help' to show the help menu. If no errors are detected you should see the line 'Conversion complete' in your terminal. The data is stored in a SystemLabel-CT.pdb file. The charge transfer is in the 9th column after the column containg 1.00. 

If your calculation is not spin polarized the charge transfer is calculated using this formula : 

$$ C_T = V_E - B_D $$

Where $C_T$ is the charge transfer, $V_E$ is the valence electrons and $B_D$ is the Bader charges in the ACF.dat file. If your calculation is spin polarized, the formula used is instead : 

$$ C_T= V_E - (C_U + C_D) $$

where $C_U$ and $C_D$ are the up charges from the ACF.UP.dat and ACF.DN.dat files

### bader2spind
---

The bader2spind script uses data from .xyz and ACF.dat files to calculate the spin density and store it in a SystemLabel-SD.pdb. This script is pratically the same as the [bader2pdb](#bader2pdb) script. The differences are mainly related to the spin polarization and the calculation of the spin density. No arguments are used in this script so tu use it simply run the python script followed by your system's label. In addition, the spin density is calculated using this formula 

$$ S_D = C_U - C_D $$

Where $S_D$ is the spin density. Although the term spin density is used here, the value calculated is per atom and is closer to the spin moment associated with each atom. The requirements, warnings and important notices are the same as the [bader2pdb](#bader2pdb) script so please refer to this section for more information

### plot_Badercharge
---

This script plots either the charge transfer or spin density of the data in the .pdb files generated by the [bader2spind](#bader2spind) and [bader2pdb](#bader2pdb) python scripts. This script is suited more for 1D or 2D structures with atoms aligned on the same z plane. 

Requierements (one of the three) : 
- SystemLabels-CT.pdb to visualize charge transfer
- SystemLabels-SD.pdb to visualize spin density (use -s option)
- Muliken population grouped in a .xyz file (use -m option) *Currently in developpement, NOT AVAILABLE 

By default the script will plot the charge transfer using Bader analysis in SystemLabels-CT.pdb file, but you can change the data plotted by using options. Use the -s option to plot the spin density instead and use -m otption to use charges from Muliken population instead. For a reminder, you can also use the -h option for help. 

The script contains also two dictionnary called 'excluded_atoms' and 'labelAtoms' to control which atoms do not make bonds (excluded_atoms) and atoms that the label will be showed. Remove or add atoms to dictionnary directly in the script. 

### plot_STM-lib
---

This script is used to visualize STM image from the .dat file genreated by the plstm util integrated with SIESTA. The scripts takes only the STM .dat file as argument and return a .png displaying the STM image with a colorbar with with values current values. To run the script simply type

```bash
python path/to/script/plot_STM-lib.py filename
```

This script has been designed to be used with the plstm util at constant height, but should also work at constant current. The only modification needed is to change the label of the colorbar units (by default displaying 'Current (A)'). 


## Contributing

We would like to thank [Chat-GPT](https://chat.openai.com/) for its help in the developpement of all the scripts

If you encounter problems or have any questions, feel free to contact us !   
Vincent Girouard : vincent-2.girouard@polymtl.ca  
Francis Blais : francis.blais@polymtl.ca


