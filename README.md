![nanostructure](https://www.polymtl.ca/nanostructures/images/ldip_cc-sib-model_1-large.stmvpjet-2-766.jpg)

 ####################################################################################### 
 ```
  _   _                       _                   _                    _          _      
 | \ | | __ _ _ __   ___  ___| |_ _ __ _   _  ___| |_ _   _ _ __ ___  | |    __ _| |__   
 |  \| |/ _` | '_ \ / _ \/ __| __| '__| | | |/ __| __| | | | '__/ _ \ | |   / _` | '_ \  
 | |\  | (_| | | | | (_) \__ \ |_| |  | |_| | (__| |_| |_| | | |  __/ | |__| (_| | |_) | 
 |_| \_|\__,_|_| |_|\___/|___/\__|_|   \__,_|\___|\__|\__,_|_|  \___| |_____\__,_|_.__/  
 
 ```                                                                                        
 ####################################################################################### 


# Table of Contents

- [Description](#description)
- [Prerequisites](#prerequisites)
- [Getting Started](#getting-started)
- [Usage](#usage)
    - [Bash Scripts](#bash-scripts)
        - [baderanalysis](#baderanalysis)
        - [scanSTM](#scanstm)
    - [Python Scripts](#python-scripts)
        - [bader2pdb](#bader2pdb)
        - [bader2spind](#bader2spind)
        - [plot_Badercharge](#plot_baderchargepy)
        - [plot_STM-lib](#plot_stm-lib)
- [Contributing](#contributing)

# Description

Multiple scripts to optimize and facilitate data analysis and processing of files generated by SIESTA (4.1.5)

Note : The scripts are designed with SIESTA data files but can be adapted to other software too

# Prerequisites

These are the software version used originally in making the scripts. Any other version might also work 

- Python (version 3.10.2)
    * Matplotlib (version 3.7.2)
    * Numpy (version 1.25.2)
    * Basic python libraries (sys, os, argparse, ...)
- Bash (version 5.1.16) 



Note : Other shells might work too but scripts will have to be adapted

# Getting Started

1. Clone or download the project repository.
2. Unzip the downloaded file.(should already be done)
3. Move the bash scripts to an appropriate directory in PATH to be accessible from the commandline (optionnal)
4. Move the python scripts to the desired directory (optionnal)
5. See instructions below for usage of specific scripts

# Usage


### Running Python Scripts
You can run the python scripts directly in the command line with its associated path. For example, to run a python script that takes the System's Label as argument, you can run this command in terminal.   

```bash
python path_to_my_python_script/pyton_script.py YourLabel 
```

However, I suggests to create a seperate bash script (in a directory added to your PATH) that run your python scripts. This way you can run the command from any directories which makes the analysis easier and more importantly FASTER! Here is an example of a simple bash script that runs the same python script from the previous example. 

```bash
#!/bin/bash
LABEL=$1
python path_to_my_python_script/pyton_script.py $LABEL
```
Don't forget to give the permissions to your bash script by runing this command in the terminal

```bash
chmod u+x YourBashScript
```
Some python scripts may have more than one argument and/or options. If you want to use the shell scripting approach, you will need to adapt your bash scripts to match the python's script arguments and/or options. All the python scripts presented in future sections will be showing the first method as indication, but I think shell scripting is a better approach
## Bash scripts

### baderanalysis
---

baderanalysis is a bash script that automatically performs the bader analysis with siesta files and returns the data in multiple output files. It is meant to speed up the process of bader analysis. 

Requirements : 
- bader executable downloadable here : [http://theory.cm.utexas.edu/henkelman/code/bader/](http://theory.cm.utexas.edu/henkelman/code/bader/)
- python scripts [bader2pdb](#bader2pdb) and [plot_Badercharge](#plot_badercharge) (optional)
- SIESTA SystemLabel.RHO file
- SIESTA SystemLabel.BADER file
- SIESTA SystemLabel.XV file
- SIESTA SystemLabel.STRUCT_OUT file (optionnal : only needed if grid non-orthogonal)
- SIESTA SystemLabel.xyz file (optionnal : only needed if python scripts are enabled)

IMPORTANT : You NEED to change the path to the python scripts in the baderanalysis script directly. The bader executable need to be in your PATH (accesssible via terminal)

To disable the python scripts, simply remove or comment lines calling the scripts (By default only the [bader2pdb](#bader2pdb) script is enabled). The script also offers multiple options depending if your grid is orthogonal, or if your calculation is spin polarized. 

Options :   
Usage: baderanalysis [-s] [-n] [-l label] [-h] 
+  -s                 Process spin-polarized data
+  -n                 Process with non-orthogonal grid
+  -l                 Specify label of your system (MANDATORY)
+  -h                 Display this help message

This script will output 5 files:
- SystemLabel-ACF.dat, SystemLabel-AVF.dat and SystemLabel-BCF.dat which are files created by the bader analysis itself, 
- SystemLabel-CT.pdb, which is a file created by the [bader2pdb](#bader2pdb) python script (refer to section its for more information)
- SystemLabel-CT.png, which is a file created by the [plot_Badercharge](#plot_badercharge) python script (refer to section its for more information)

By default, the script will delete all the .cube files generated by the bader analysis but you can prevent this by simply commenting the lines in the script that remove those files 


### scanSTM
---

The scanSTM bash script is meant to give multiple STM usage by scanning at multiple different height. It takes data from the SystemsLabel.LDOS file generated by SIESTA and generates multiple STM .dat files with the plstm util integrated with SIESTA. With the [plot_STM-lib](#plot_stm-lib) and the .dat files, it then generates an STM image for each height. 

Requirements : 
- SIESTA .LDOS file
- [plot_STM-lib](#plot_stm-lib) script provided in this project

The script requires multiple options in order to work properly. Here is the list of options available

Options:
+ -m MIN_HEIGHT   Minimal height in Angstrom (default: 2)
+ -M MAX_HEIGHT   Maximal height in Angstrom (default: 7)
+ -n NUM_STEPS    Number of steps between minimal and maximal heights (default: 10)
+ -l LABEL        System's label associated with .LDOS file (MUST PROVIDE)
+ -h              Display help message

The script generates multiple files. The STM data are stored in files named SystemLabel-SZ-$HEIGHT.dat and images are in files named SystemLabel-SZ-$HEIGHT.png where $HEIGHT is the constant height in Ang at which the image has been generated. 

IMPORTANT : You NEED to modify the path to the [plot_STM-lib](#plot_stm-lib) directly in the bash script
## Python scripts


### bader2pdb
---
The bader2pdb script is used to automatically take the data from the ACF.dat and .xyz files generated by SIESTA and BADER respectively, and create a .pdb file regrouping the data and calculate the charge transfer that can be used to visualize in VMD. The scripts is assuming that your ACF.dat files has been renamed to SystemLabel-ACF.dat (if spin polarized to SystemLabel-UP-ACF.dat and SystemLabel-DN-ACF.dat). If this is not the case please change to your filename in the script directly.

IMPORTANT : The atom numbers from the .xyz and the ACF.dat file must match in order to have the correct charge transfer associated with its atom. This should be the case, if you used the .XV file from siesta to generate the .cube files (from grid2cube or g2c utilities) used in the bader analysis

Requirements : 
- SIESTA .xyz file
- BADER ACF.dat file (you do not need the .BADER file)


If your calculation is spin polarized than you should add the '-s' or '--spin' flag before your label.

```bash
python path/to/script/bader2pdb.py -s YourSystemsLabel
```
You can also use the '-h' or '--help' to show the help menu. If no errors are detected you should see the line 'Conversion complete' in your terminal. The data is stored in a SystemLabel-CT.pdb file. The charge transfer is in the 9th column after the column containg 1.00. 

If your calculation is not spin polarized the charge transfer is calculated using this formula : 

$$ C_T = V_E - B_D $$

Where $C_T$ is the charge transfer, $V_E$ is the valence electrons and $B_D$ is the Bader charges in the ACF.dat file. If your calculation is spin polarized, the formula used is instead : 

$$ C_T= V_E - (C_U + C_D) $$

where $C_U$ and $C_D$ are the up charges from the ACF.UP.dat and ACF.DN.dat files

### bader2spind
---

The bader2spind script uses data from .xyz and ACF.dat files to calculate the spin density and store it in a SystemLabel-SD.pdb. This script is pratically the same as the [bader2pdb](#bader2pdb) script. The differences are mainly related to the spin polarization and the calculation of the spin density. No arguments are used in this script so tu use it simply run the python script followed by your system's label. In addition, the spin density is calculated using this formula 

$$ S_D = C_U - C_D $$

Where $S_D$ is the spin density. Although the term spin density is used here, the value calculated is per atom and is closer to the spin moment associated with each atom. The requirements, warnings and important notices are the same as the [bader2pdb](#bader2pdb) script so please refer to this section for more information

### plot_Badercharge
---

This script plots either the charge transfer or spin density of the data in the .pdb files generated by the [bader2spind](#bader2spind) and [bader2pdb](#bader2pdb) python scripts. This script is suited more for 1D or 2D structures with atoms aligned on the same z plane. 

Requierements (one of the three) : 
- SystemLabels-CT.pdb to visualize charge transfer
- SystemLabels-SD.pdb to visualize spin density (use -s option)
- Muliken population grouped in a .xyz file (use -m option) *Currently in developpement, NOT AVAILABLE 

By default the script will plot the charge transfer using Bader analysis in SystemLabels-CT.pdb file, but you can change the data plotted by using options. Use the -s option to plot the spin density instead and use -m otption to use charges from Muliken population instead. For a reminder, you can also use the -h option for help. 

The script contains also two dictionnary called 'excluded_atoms' and 'labelAtoms' to control which atoms do not make bonds (excluded_atoms) and atoms that the label will be showed. Remove or add atoms to dictionnary directly in the script. 

### plot_STM-lib
---

This script is used to visualize STM image from the .dat file genreated by the plstm util integrated with SIESTA. The scripts takes only the STM .dat file as argument and return a .png displaying the STM image with a colorbar with with values current values. To run the script simply type

```bash
python path/to/script/plot_STM-lib.py filename
```

This script has been designed to be used with the plstm util at constant height, but should also work at constant current. The only modification needed is to change the label of the colorbar units (by default displaying 'Current (A)'). 


## Contributing

We would like to thank [Chat-GPT](https://chat.openai.com/) for its help in the developpement of all the scripts

If you encounter problems or have any questions, feel free to contact us !   
Vincent Girouard : vincent-2.girouard@polymtl.ca  
Francis Blais : francis.blais@polymtl.ca


